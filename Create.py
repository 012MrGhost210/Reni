import pandas as pd
import os

# –ú–∞–ø–ø–∏–Ω–≥ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
portfolio_mapping = {
    '020611/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 020611/1 SPURZ 1',
    '020611/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 020611/2 SPURZ 2', 
    '020611/3': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 020611/3 SPURZ 3',
    '081121/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 081121/1 SPURZ 11',
    '081121/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 081121/2 SPURZ 12',
    '141111/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 141111/1 SPURZ 4',
    '190221/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 190221/1 SPURZ 10',
    '220223/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 220223/1 SPURZ 13',
    '220223/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 220223/2 SPURZ 14',
    '260716/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 260716/1 SPURZ 5',
    '271210/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 271210/2 SPURZ',
    '050925/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 050925/1 SPURZ 15'
}

def process_merger_file_fixed(input_file_path, output_file_path):
    """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ –ú–µ—Ä–¥–∂–µ—Ä.xlsx"""
    
    print(f"–ß–∏—Ç–∞—é —Ñ–∞–π–ª: {input_file_path}")
    
    try:
        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º (—Å—Ç—Ä–æ–∫–∞ 1 –≤ 0-based –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏)
        df = pd.read_excel(input_file_path, header=1)
        print(f"–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ: {len(df)}")
        print(f"–ü–µ—Ä–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {df.columns.tolist()[:10]}")  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 –∫–æ–ª–æ–Ω–æ–∫
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É –≤ '–ü–æ—Ä—Ç—Ñ–µ–ª—å'
        df = df.rename(columns={df.columns[0]: '–ü–æ—Ä—Ç—Ñ–µ–ª—å'})
        print(f"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –≤: '–ü–æ—Ä—Ç—Ñ–µ–ª—å'")
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ –ü–æ—Ä—Ç—Ñ–µ–ª—å
        df = df[df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].notna()]
        
        # –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –ü–æ—Ä—Ç—Ñ–µ–ª—å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
        df = df[df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].astype(str).str.len() < 100]
        
        print(f"–°—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {len(df)}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∏—Ö –ø–æ–∑–∏—Ü–∏—è–º
        # –ò–∑ –∞–Ω–∞–ª–∏–∑–∞: 
        # - –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º 13 (14-—è –∫–æ–ª–æ–Ω–∫–∞)
        # - –ù–ö–î –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º 14 (15-—è –∫–æ–ª–æ–Ω–∫–∞)  
        # - –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º 15 (16-—è –∫–æ–ª–æ–Ω–∫–∞)
        
        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
        column_mapping = {
            df.columns[13]: '–°—Ç–æ–∏–º–æ—Å—Ç—å',
            df.columns[14]: '–ù–ö–î', 
            df.columns[15]: '–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏'
        }
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        df = df.rename(columns=column_mapping)
        print(f"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {list(column_mapping.values())}")
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        numeric_columns = ['–°—Ç–æ–∏–º–æ—Å—Ç—å', '–ù–ö–î', '–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏']
        for col in numeric_columns:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
                print(f"–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ {col}")
            else:
                print(f"‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ {col} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é –∏ —Å—É–º–º–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        grouped_df = df.groupby('–ü–æ—Ä—Ç—Ñ–µ–ª—å')[numeric_columns].sum().reset_index()
        print(f"–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π: {len(grouped_df)}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞
        def get_full_portfolio_name(portfolio):
            portfolio_str = str(portfolio)
            for key, value in portfolio_mapping.items():
                if key in portfolio_str:
                    return value
            return portfolio_str
        
        grouped_df['–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è'] = grouped_df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].apply(get_full_portfolio_name)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –æ—Ç—á–µ—Ç–∞ (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–ª–æ–Ω–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏)
        try:
            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–ª–æ–Ω–∫—É
            last_row_idx = df.last_valid_index()
            if last_row_idx is not None:
                last_col_idx = df.columns[-1]
                date_value = df.loc[last_row_idx, last_col_idx]
                if hasattr(date_value, 'strftime'):
                    date_str = date_value.strftime('%d.%m.%Y')
                else:
                    date_str = str(date_value)
            else:
                date_str = "01.10.2025"
        except:
            date_str = "01.10.2025"
            
        grouped_df['–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞'] = date_str
        print(f"–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞: {date_str}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π DataFrame
        result_columns = ['–ü–æ—Ä—Ç—Ñ–µ–ª—å', '–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è', '–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞'] + numeric_columns
        result_df = grouped_df[result_columns]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result_df.to_excel(output_file_path, index=False)
        print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file_path}")
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
        print(f"\nüìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
        print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π: {len(result_df)}")
        print(f"–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {result_df['–°—Ç–æ–∏–º–æ—Å—Ç—å'].sum():,.2f}")
        print(f"–û–±—â–∏–π –ù–ö–î: {result_df['–ù–ö–î'].sum():,.2f}")
        print(f"–û–±—â–∏–µ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏: {result_df['–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏'].sum():,.2f}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª–∏ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
        print("\n–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ç—Ñ–µ–ª–∏:")
        for _, row in result_df.iterrows():
            print(f"  - {row['–ü–æ—Ä—Ç—Ñ–µ–ª—å']} -> {row['–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è']} (–°—Ç–æ–∏–º–æ—Å—Ç—å: {row['–°—Ç–æ–∏–º–æ—Å—Ç—å']:,.2f})")
        
        return result_df
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
        import traceback
        traceback.print_exc()
        return None

def process_alternative_approach(input_file_path, output_file_path):
    """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - —á—Ç–µ–Ω–∏–µ —Å —Ä—É—á–Ω—ã–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–ª–æ–Ω–æ–∫"""
    
    try:
        print(f"\nüîÑ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ü–û–î–•–û–î...")
        
        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        df = pd.read_excel(input_file_path, header=None)
        
        # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        header_row = None
        for i in range(min(5, len(df))):
            if '–ü–æ—Ä—Ç—Ñ–µ–ª—å' in str(df.iloc[i, 0]):
                header_row = i
                break
        
        if header_row is None:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ '–ü–æ—Ä—Ç—Ñ–µ–ª—å'")
            return None
            
        print(f"–ù–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å—Ç—Ä–æ–∫–µ: {header_row}")
        
        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        df = pd.read_excel(input_file_path, header=header_row)
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–∞—á–µ
        first_col_name = df.columns[0]
        df = df.rename(columns={first_col_name: '–ü–æ—Ä—Ç—Ñ–µ–ª—å'})
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        df = df[df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].notna()]
        df = df[df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].astype(str).str.len() < 100]
        
        print(f"–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏: {len(df)}")
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø–∏—Å–µ–π (–¥–ª—è —Ç–µ—Å—Ç–∞)
        grouped_df = df.groupby('–ü–æ—Ä—Ç—Ñ–µ–ª—å').size().reset_index(name='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø–∏—Å–µ–π')
        grouped_df['–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è'] = grouped_df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].apply(
            lambda x: next((v for k, v in portfolio_mapping.items() if k in str(x)), str(x))
        )
        grouped_df['–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞'] = "01.10.2025"
        
        grouped_df.to_excel(output_file_path, index=False)
        print(f"‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file_path}")
        
        return grouped_df
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º –ø–æ–¥—Ö–æ–¥–µ: {e}")
        return None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
if __name__ == "__main__":
    input_file = "M:\\–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç\\Treasury\\–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö(–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)\\DI_DATABASE\\–ú–µ—Ä–¥–∂–µ—Ä.xlsx"
    output_file = "–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ_–ø–æ—Ä—Ç—Ñ–µ–ª–∏.xlsx"
    
    # –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
    result = process_merger_file_fixed(input_file, output_file)
    
    # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥
    if result is None:
        result = process_alternative_approach(input_file, "–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π_—Ä–µ–∑—É–ª—å—Ç–∞—Ç.xlsx")
    
    if result is not None:
        print(f"\n‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!")
        print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_file}")
