import pandas as pd
import os

# –ú–∞–ø–ø–∏–Ω–≥ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
portfolio_mapping = {
    '020611/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 020611/1 SPURZ 1',
    '020611/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 020611/2 SPURZ 2', 
    '020611/3': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 020611/3 SPURZ 3',
    '081121/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 081121/1 SPURZ 11',
    '081121/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 081121/2 SPURZ 12',
    '141111/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 141111/1 SPURZ 4',
    '190221/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 190221/1 SPURZ 10',
    '220223/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 220223/1 SPURZ 13',
    '220223/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 220223/2 SPURZ 14',
    '260716/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 260716/1 SPURZ 5',
    '271210/2': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 271210/2 SPURZ',
    '050925/1': '–î–£ ¬´–°–ø—É—Ç–Ω–∏–∫-–£–ö¬ª 050925/1 SPURZ 15'
}

def process_single_portfolio_file(input_file_path, output_file_path):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏"""
    
    print(f"–ß–∏—Ç–∞—é —Ñ–∞–π–ª: {input_file_path}")
    
    try:
        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
        df = pd.read_excel(input_file_path, header=4)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ —Ñ–∞–π–ª–∞
        df_meta = pd.read_excel(input_file_path, header=None, nrows=2)
        date_str = df_meta.iloc[1, 0].replace('–Ω–∞ –¥–∞—Ç—É ', '').split(' ')[0]
        print(f"–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞: {date_str}")
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
        df = df[df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].notna()]
        print(f"–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        numeric_columns = ['–°—Ç–æ–∏–º–æ—Å—Ç—å', '–ù–ö–î,–Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ %', '–î–µ–±–µ—Ç–æ—Ä—Å–∫–∞—è/ –ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏']
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        for col in numeric_columns:
            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é –∏ —Å—É–º–º–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        grouped_df = df.groupby('–ü–æ—Ä—Ç—Ñ–µ–ª—å')[numeric_columns].sum().reset_index()
        print(f"–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π: {len(grouped_df)}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞
        def get_full_portfolio_name(portfolio):
            for key, value in portfolio_mapping.items():
                if key in portfolio:
                    return value
            return portfolio
        
        grouped_df['–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è'] = grouped_df['–ü–æ—Ä—Ç—Ñ–µ–ª—å'].apply(get_full_portfolio_name)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –æ—Ç—á–µ—Ç–∞
        grouped_df['–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞'] = date_str
        
        # –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
        result_df = grouped_df[['–ü–æ—Ä—Ç—Ñ–µ–ª—å', '–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è', '–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞'] + numeric_columns]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏
        result_df.to_excel(output_file_path, index=False)
        print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file_path}")
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
        print(f"\nüìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
        print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π: {len(result_df)}")
        print(f"–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {result_df['–°—Ç–æ–∏–º–æ—Å—Ç—å'].sum():,.2f}")
        print(f"–û–±—â–∏–π –ù–ö–î: {result_df['–ù–ö–î,–Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ %'].sum():,.2f}")
        
        return result_df
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
        return None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ - –ü–†–û–°–¢–û –ü–û–î–°–¢–ê–í–¨ –°–í–û–ò –ü–£–¢–ò!
if __name__ == "__main__":
    # –£–∫–∞–∂–∏ –∑–¥–µ—Å—å –ø—É—Ç–∏ –∫ —Å–≤–æ–∏–º —Ñ–∞–π–ª–∞–º
    input_file = "C:/–ø—É—Ç—å/–∫/—Ç–≤–æ–µ–º—É/—Ñ–∞–π–ª—É/—Ç–µ—Å—Ç –∫–∫—É—É.xlsx"  # –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª
    output_file = "C:/–ø—É—Ç—å/–∫—É–¥–∞/—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ_–ø–æ—Ä—Ç—Ñ–µ–ª–∏.xlsx"  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
    result = process_single_portfolio_file(input_file, output_file)
    
    if result is not None:
        print("\n–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
        print(result.head())
